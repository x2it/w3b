<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的IP查询工具</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1677ff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #333;
            --text-light: #666;
            --border: #e5e7eb;
            --radius: 10px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Microsoft YaHei", sans-serif;
            color: var(--text);
            background: var(--bg);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        .logo {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-bottom: 10px;
        }
        .logo i { color: var(--primary); font-size: 32px; }
        .logo h1 { font-size: 24px; color: var(--text); }
        .subtitle { color: var(--text-light); font-size: 14px; }
        .main { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .main { grid-template-columns: 2fr 1fr; } }
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-title i { color: var(--primary); }
        .query-form { display: flex; gap: 10px; margin-bottom: 20px; }
        .query-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 16px;
            transition: all 0.3s;
        }
        .query-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(22, 119, 255, 0.1);
        }
        .query-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 0 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .query-btn:hover { opacity: 0.9; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-light); }
        .info-value {
            font-weight: 500;
            text-align: right;
            max-width: 60%;
            word-break: break-all;
        }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: white;
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn:hover { background: #f9fafb; }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-primary:hover { opacity: 0.9; }
        .time-card {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .time-date { font-size: 16px; color: var(--text-light); margin-bottom: 10px; }
        .time-clock {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            font-family: "Consolas", monospace;
        }
        .history-list { max-height: 200px; overflow-y: auto; }
        .history-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }
        .history-item:hover { background: #f9fafb; }
        .history-ip { font-weight: 500; }
        .history-time { font-size: 12px; color: var(--text-light); }
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--text-light);
            font-size: 14px;
            border-top: 1px solid var(--border);
        }
        @media (max-width: 767px) {
            .query-form, .btn-group { flex-direction: column; }
        }
        .error { color: var(--danger); margin-top: 10px; text-align: center; }
        .weather-detail { display: flex; justify-content: space-between; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-network-wired"></i>
                <h1>我的IP查询工具</h1>
            </div>
            <p class="subtitle">查询真实IP、地理位置与对应天气</p>
        </header>
        <div class="main">
            <div>
                <div class="card">
                    <div class="card-title"><i class="fas fa-search-location"></i> IP地址查询</div>
                    <form class="query-form" id="ipQueryForm">
                        <input type="text" class="query-input" id="ipInput" placeholder="输入IP地址或域名 (如: 8.8.8.8 或 baidu.com)" value="">
                        <button type="submit" class="query-btn" id="queryBtn">查询</button>
                    </form>
                    <div class="card-title"><i class="fas fa-info-circle"></i> 查询结果</div>
                    <div id="ipInfo"></div>
                    <div class="btn-group">
                        <button class="btn" id="refreshBtn"><i class="fas fa-redo"></i> 刷新</button>
                        <button class="btn" id="copyBtn"><i class="fas fa-copy"></i> 复制结果</button>
                        <button class="btn btn-primary" id="myIpBtn"><i class="fas fa-home"></i> 我的IP</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title"><i class="fas fa-map-marker-alt"></i> 地理位置</div>
                    <div id="locationInfo"></div>
                </div>
                <div class="card">
                    <div class="card-title"><i class="fas fa-cloud-sun"></i> 当地天气</div>
                    <div id="weatherInfo"></div>
                </div>
            </div>
            <div>
                <div class="time-card">
                    <div class="time-date" id="currentDate">--</div>
                    <div class="time-clock" id="currentTime">--:--:--</div>
                </div>
                <div class="card">
                    <div class="card-title"><i class="fas fa-history"></i> 查询历史</div>
                    <div class="history-list" id="historyList">暂无查询历史</div>
                </div>
                <div class="card">
                    <div class="card-title"><i class="fas fa-bolt"></i> 快捷查询</div>
                    <div class="btn-group">
                        <button class="btn" onclick="queryIP('8.8.8.8')"><i class="fas fa-globe-americas"></i> Google DNS</button>
                        <button class="btn" onclick="queryIP('114.114.114.114')"><i class="fas fa-server"></i> 114DNS</button>
                    </div>
                    <div class="btn-group" style="margin-top:10px;">
                        <button class="btn" onclick="queryDomain('baidu.com')"><i class="fas fa-sitemap"></i> 百度</button>
                        <button class="btn" onclick="queryDomain('github.com')"><i class="fab fa-github"></i> GitHub</button>
                    </div>
                </div>
            </div>
        </div>
        <footer>
            <p>我的IP查询工具 &copy; 2026 | 基于真实API构建</p>
        </footer>
    </div>

    <script>
        /* ========== 重要：请填写以下从各平台申请的API密钥 ========== */
        // 1. 华东师范大学 API (用于IP地理查询) [citation:2]
        const ECNU_CLIENT_ID = 'YOUR_CLIENT_ID'; // 请替换为您的 Client ID
        const ECNU_CLIENT_SECRET = 'YOUR_CLIENT_SECRET'; // 请替换为您的 Client Secret
        let ECNU_ACCESS_TOKEN = ''; // 程序会自动获取，无需填写

        // 2. 百度地图 API (用于天气查询) [citation:3][citation:8]
        const BAIDU_MAP_AK = 'YOUR_BAIDU_MAP_AK'; // 请替换为您的百度地图AK

        // 3. 百度云市场IP定位 (可选，用于获取“我的IP”，更稳定)
        const BAIDU_API_ACCESSKEY = 'YOUR_ACCESSKEY'; // 可选：百度云市场 AccessKey
        const BAIDU_API_SECRETKEY = 'YOUR_SECRETKEY'; // 可选：百度云市场 SecretKey
        /* ========== 密钥填写结束 ========== */

        // DOM 元素
        const dom = {
            ipInput: document.getElementById('ipInput'),
            ipInfo: document.getElementById('ipInfo'),
            locationInfo: document.getElementById('locationInfo'),
            weatherInfo: document.getElementById('weatherInfo'),
            historyList: document.getElementById('historyList'),
            currentDate: document.getElementById('currentDate'),
            currentTime: document.getElementById('currentTime')
        };

        // 状态
        let queryHistory = JSON.parse(localStorage.getItem('ipQueryHistory') || '[]');
        let currentData = null;

        // 页面初始化
        window.addEventListener('load', () => {
            updateClock(); setInterval(updateClock, 1000);
            loadHistory();
            initEvents();
            // 尝试获取ECNU的Access Token并查询本机IP
            fetchECNUToken().then(() => getMyIP());
        });

        function initEvents() {
            document.getElementById('ipQueryForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const query = dom.ipInput.value.trim();
                if (query) await queryIPOrDomain(query);
            });
            document.getElementById('refreshBtn').addEventListener('click', () => {
                if (currentData && currentData.ip) queryIPOrDomain(currentData.ip);
            });
            document.getElementById('copyBtn').addEventListener('click', copyResults);
            document.getElementById('myIpBtn').addEventListener('click', getMyIP);
        }

        // 1. 获取华东师范大学API的Access Token [citation:2]
        async function fetchECNUToken() {
            const url = 'https://api.ecnu.edu.cn/oauth2/token';
            const params = new URLSearchParams({
                grant_type: 'client_credentials',
                client_id: ECNU_CLIENT_ID,
                client_secret: ECNU_CLIENT_SECRET
            });
            try {
                const res = await fetch(url, { method: 'POST', body: params });
                const data = await res.json();
                if (data.access_token) ECNU_ACCESS_TOKEN = data.access_token;
                else console.error('获取Token失败:', data);
            } catch (err) { console.error('Token请求失败:', err); }
        }

        // 2. 主查询函数：支持IP和域名
        async function queryIPOrDomain(query) {
            showLoading();
            try {
                let ipToQuery = query;
                // 如果是域名，先解析
                if (/[a-zA-Z]/.test(query) && query.includes('.')) {
                    ipToQuery = await resolveDomain(query);
                    if (!ipToQuery) throw new Error('域名解析失败');
                }
                // 使用华东师范大学API查询IP地理位置 [citation:2]
                const geoData = await fetchIPGeoFromECNU(ipToQuery);
                // 使用百度地图API查询该位置天气 [citation:3][citation:8]
                const weatherData = await fetchWeatherFromBaidu(geoData);
                // 整合并显示数据
                currentData = { query, ip: ipToQuery, geo: geoData, weather: weatherData };
                displayAllInfo(currentData);
                addToHistory(query);
            } catch (error) {
                console.error('查询失败:', error);
                dom.ipInfo.innerHTML = `<div class="error">查询失败: ${error.message}</div>`;
            }
        }

        // 3. 使用华东师范大学API查询IP地理信息 [citation:2]
        async function fetchIPGeoFromECNU(ip) {
            if (!ECNU_ACCESS_TOKEN) await fetchECNUToken();
            const url = `https://api.ecnu.edu.cn/api/v1/network/ip?ip=${ip}`;
            const res = await fetch(url, {
                headers: { 'Authorization': `Bearer ${ECNU_ACCESS_TOKEN}` }
            });
            const result = await res.json();
            if (result.errCode === 0) return result.data;
            throw new Error(`地理查询失败: ${result.errMsg}`);
        }

        // 4. 使用百度地图API查询天气 (根据城市名) [citation:3][citation:8]
        async function fetchWeatherFromBaidu(geoData) {
            // 优先使用城市名，其次使用省份名
            const location = geoData.city || geoData.province;
            if (!location) throw new Error('无法获取有效的地理位置名称');
            const url = `https://api.map.baidu.com/weather/v1/?district_id=&data_type=all&ak=${BAIDU_MAP_AK}&location=${location}`;
            const res = await fetch(url);
            const result = await res.json();
            if (result.status === 0) return result.result;
            throw new Error(`天气查询失败: ${result.message}`);
        }

        // 5. 获取“我的IP” (使用百度云市场API，或备用方案)
        async function getMyIP() {
            showLoading();
            try {
                let myIP;
                // 方案A: 尝试百度云市场API (如有配置)
                if (BAIDU_API_ACCESSKEY && BAIDU_API_SECRETKEY) {
                    const url = `http://ipplus360.api.bdymkt.com/ip/geo/v1/city/?ip=`;
                    const res = await fetch(url, {
                        headers: {
                            'X-Bce-Signature': `AppCode/${BAIDU_API_ACCESSKEY}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await res.json();
                    if (data && data.ip) myIP = data.ip;
                }
                // 方案B: 备用公共API
                if (!myIP) {
                    const res = await fetch('https://api.ipify.org?format=json');
                    const data = await res.json();
                    myIP = data.ip;
                }
                dom.ipInput.value = myIP;
                await queryIPOrDomain(myIP);
            } catch (error) {
                console.error('获取本机IP失败:', error);
                dom.ipInfo.innerHTML = `<div class="error">无法获取您的IP，请手动输入查询</div>`;
            }
        }

        // 6. 辅助函数：解析域名 (使用公共DNS over HTTPS)
        async function resolveDomain(domain) {
            const url = `https://cloudflare-dns.com/dns-query?name=${domain}&type=A`;
            const res = await fetch(url, { headers: { 'Accept': 'application/dns-json' } });
            const data = await res.json();
            if (data.Answer && data.Answer.length > 0) {
                return data.Answer[0].data;
            }
            throw new Error('无法解析该域名');
        }

        // 7. 显示所有信息 (确保一致性)
        function displayAllInfo(data) {
            // 显示IP信息
            dom.ipInfo.innerHTML = `
                <div class="info-row"><div class="info-label">查询目标</div><div class="info-value">${data.query}</div></div>
                <div class="info-row"><div class="info-label">IP地址</div><div class="info-value">${data.ip}</div></div>
                <div class="info-row"><div class="info-label">查询时间</div><div class="info-value">${new Date().toLocaleString('zh-CN')}</div></div>
            `;
            // 显示地理位置 [citation:2]
            dom.locationInfo.innerHTML = `
                <div class="info-row"><div class="info-label">国家/地区</div><div class="info-value">${data.geo.country}</div></div>
                <div class="info-row"><div class="info-label">省份</div><div class="info-value">${data.geo.province}</div></div>
                <div class="info-row"><div class="info-label">城市</div><div class="info-value">${data.geo.city || '--'}</div></div>
                <div class="info-row"><div class="info-label">运营商</div><div class="info-value">${data.geo.isp || '--'}</div></div>
                <div class="info-row"><div class="info-label">经纬度</div><div class="info-value">${data.geo.longitude || '--'}, ${data.geo.latitude || '--'}</div></div>
            `;
            // 显示天气信息 [citation:3][citation:8]
            if (data.weather && data.weather.now) {
                const w = data.weather.now;
                dom.weatherInfo.innerHTML = `
                    <div class="info-row"><div class="info-label">温度</div><div class="info-value">${w.temp}°C (体感${w.feels_like}°C)</div></div>
                    <div class="info-row"><div class="info-label">天气</div><div class="info-value">${w.text}</div></div>
                    <div class="info-row"><div class="info-label">湿度</div><div class="info-value">${w.rh}%</div></div>
                    <div class="info-row"><div class="info-label">风力</div><div class="info-value">${w.wind_class} ${w.wind_dir}</div></div>
                    <div class="info-row"><div class="info-label">更新时间</div><div class="info-value">${w.uptime}</div></div>
                `;
            } else {
                dom.weatherInfo.innerHTML = `<div class="error">天气信息暂不可用</div>`;
            }
        }

        // 8. 工具函数
        function showLoading() {
            dom.ipInfo.innerHTML = `<div style="text-align:center;padding:20px;"><div class="loading"></div>查询中...</div>`;
            dom.locationInfo.innerHTML = dom.weatherInfo.innerHTML = '';
        }
        function addToHistory(query) {
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            queryHistory.unshift({ query, time });
            if (queryHistory.length > 8) queryHistory.pop();
            localStorage.setItem('ipQueryHistory', JSON.stringify(queryHistory));
            loadHistory();
        }
        function loadHistory() {
            dom.historyList.innerHTML = queryHistory.length ? queryHistory.map(item => `
                <div class="history-item" onclick="queryIPOrDomain('${item.query}')">
                    <div class="history-ip">${item.query}</div>
                    <div class="history-time">${item.time}</div>
                </div>
            `).join('') : '暂无查询历史';
        }
        async function copyResults() {
            const text = `IP查询结果：
IP地址: ${currentData?.ip}
地理位置: ${currentData?.geo.country} ${currentData?.geo.province} ${currentData?.geo.city}
天气: ${currentData?.weather?.now?.temp}°C ${currentData?.weather?.now?.text}
查询时间: ${new Date().toLocaleString('zh-CN')}`;
            await navigator.clipboard.writeText(text);
            alert('结果已复制到剪贴板');
        }
        function updateClock() {
            const now = new Date();
            dom.currentDate.textContent = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            dom.currentTime.textContent = now.toLocaleTimeString('zh-CN', { hour12: false });
        }
        // 全局快捷函数
        window.queryIP = (ip) => { dom.ipInput.value = ip; queryIPOrDomain(ip); };
        window.queryDomain = (domain) => { dom.ipInput.value = domain; queryIPOrDomain(domain); };
    </script>
</body>
</html>