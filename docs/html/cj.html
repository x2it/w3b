<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多功能网页爬虫工具</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #ff9e00;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border-radius: 10px;
            --box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
            padding: 30px 40px;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath fill='%23ffffff' fill-opacity='0.05' d='M0,0 L100,0 L100,100 Z' /%3E%3C/svg%3E");
            background-size: 30px;
        }
        
        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            position: relative;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.2em;
            position: relative;
            max-width: 700px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 30px;
            padding: 40px;
        }
        
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }
        
        .section:hover {
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        h2 {
            color: var(--primary);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.6em;
        }
        
        h3 {
            color: var(--secondary);
            margin: 20px 0 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 600;
            font-size: 1.05em;
        }
        
        .label-hint {
            color: var(--gray);
            font-size: 0.9em;
            font-weight: normal;
            margin-left: 5px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .range-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .range-group input {
            flex: 1;
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #eee;
            transition: var(--transition);
        }
        
        .checkbox-item:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .radio-item input[type="radio"] {
            width: auto;
        }
        
        .buttons-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }
        
        .buttons-row-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: var(--gray);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f72585 0%, #b5179e 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9e00 0%, #ff6d00 100%);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .results-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .result-count {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--primary);
        }
        
        .results-container {
            flex: 1;
            overflow-y: auto;
            max-height: 500px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #eee;
        }
        
        .result-item {
            background: white;
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 5px solid var(--primary);
            border: 1px solid #eee;
            transition: var(--transition);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-color: var(--primary);
        }
        
        .result-info {
            flex: 1;
            word-break: break-all;
        }
        
        .result-url {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
            font-size: 1.05em;
        }
        
        .result-details {
            font-size: 0.9em;
            color: var(--gray);
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }
        
        .result-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light);
            color: var(--primary);
            border: 1px solid #ddd;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .action-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }
        
        .loading-spinner {
            border: 5px solid rgba(67, 97, 238, 0.1);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.1em;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .progress-container {
            margin: 25px 0;
        }
        
        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.95em;
            color: var(--gray);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 18px 25px;
            background: var(--success);
            color: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: translateX(150%);
            transition: transform 0.4s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 25px;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .checkbox-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .buttons-row, .buttons-row-3 {
                grid-template-columns: 1fr;
            }
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 3em;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        .pagination-info {
            background: rgba(67, 97, 238, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.95em;
        }
        
        .advanced-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #eee;
            margin-top: 15px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .advanced-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }
        
        .advanced-content.expanded {
            max-height: 1000px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            flex: 1;
            min-width: 120px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #eee;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: var(--gray);
        }
        
        .proxy-selector {
            margin-top: 10px;
        }
        
        .proxy-status {
            font-size: 0.9em;
            margin-top: 5px;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        
        .proxy-status.active {
            background: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
        }
        
        .proxy-status.inactive {
            background: rgba(247, 37, 133, 0.2);
            color: #f72585;
        }
        
        .demo-mode {
            background: rgba(255, 193, 7, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #ffc107;
        }
        
        .export-options {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .export-format-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            border: 2px solid #eee;
        }
        
        .export-format-selector label {
            margin: 0;
            font-weight: 600;
        }
        
        .export-format-selector select {
            width: auto;
            min-width: 120px;
            padding: 8px 15px;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .quick-action-btn {
            padding: 8px 15px;
            background: var(--light);
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9em;
        }
        
        .quick-action-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .result-filter {
            margin-bottom: 15px;
        }
        
        .result-filter input {
            padding: 10px 15px;
            font-size: 0.95em;
        }
        
        .result-summary {
            background: rgba(67, 97, 238, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95em;
            border-left: 4px solid var(--primary);
        }
        
        .export-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            border: 1px solid #dee2e6;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-spider"></i> 多功能网页爬虫工具</h1>
            <p>从单页或多页网页中提取符合筛选条件的用户链接，支持分页控制、高级筛选和多格式导出</p>
        </div>
        
        <div class="main-content">
            <!-- 左侧：配置区域 -->
            <div class="section">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('basic')"><i class="fas fa-cog"></i> 基本设置</div>
                    <div class="tab" onclick="switchTab('advanced')"><i class="fas fa-sliders-h"></i> 高级设置</div>
                </div>
                
                <!-- 基本设置标签 -->
                <div id="basic-tab" class="tab-content active">
                    <div class="form-group">
                        <label for="base-url">基础URL <span class="label-hint">(支持分页占位符 {page})</span></label>
                        <input type="url" id="base-url" placeholder="例如: https://example.com/users?page={page}" value="">
                    </div>
                    
                    <div class="form-group">
                        <label>分页控制</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="page-all" name="page-mode" value="all" checked>
                                <label for="page-all">所有页面</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="page-range" name="page-mode" value="range">
                                <label for="page-range">页面范围</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="page-single" name="page-mode" value="single">
                                <label for="page-single">单页</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="page-range-controls" style="display: none;">
                        <div class="range-group">
                            <div class="form-group" style="flex: 1;">
                                <label for="start-page">起始页码</label>
                                <input type="number" id="start-page" value="1" min="1">
                            </div>
                            <div style="font-size: 1.5em; color: var(--gray); margin-top: 10px;">~</div>
                            <div class="form-group" style="flex: 1;">
                                <label for="end-page">结束页码</label>
                                <input type="number" id="end-page" value="5" min="1">
                            </div>
                        </div>
                    </div>
                    
                    <div id="single-page-control" style="display: none;">
                        <div class="form-group">
                            <label for="single-page">页码</label>
                            <input type="number" id="single-page" value="1" min="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="max-results">每页最大结果数</label>
                        <input type="number" id="max-results" value="50" min="1" max="500">
                    </div>
                    
                    <div class="form-group">
                        <label for="proxy-mode">工作模式</label>
                        <select id="proxy-mode">
                            <option value="demo">演示模式（无网络请求）</option>
                            <option value="direct">直接请求（仅同源或CORS允许）</option>
                            <option value="cors">CORS代理</option>
                        </select>
                        <div id="proxy-status" class="proxy-status active">当前：演示模式</div>
                    </div>
                    
                    <div class="advanced-toggle" onclick="toggleAdvanced()">
                        <span><i class="fas fa-filter"></i> 链接筛选条件</span>
                        <i class="fas fa-chevron-down" id="advanced-chevron"></i>
                    </div>
                    
                    <div class="advanced-content" id="advanced-content">
                        <h3><i class="fas fa-filter"></i> 链接关键词筛选</h3>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="filter-user" checked>
                                <label for="filter-user">user</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="filter-profile" checked>
                                <label for="filter-profile">profile</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="filter-member">
                                <label for="filter-member">member</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="filter-account">
                                <label for="filter-account">account</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="filter-author">
                                <label for="filter-author">author</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="filter-people">
                                <label for="filter-people">people</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="custom-filter">自定义关键词 <span class="label-hint">(用逗号分隔)</span></label>
                            <input type="text" id="custom-filter" placeholder="例如: user, profile, account">
                        </div>
                        
                        <h3><i class="fas fa-link"></i> URL模式筛选</h3>
                        <div class="form-group">
                            <label for="url-pattern">URL必须包含</label>
                            <input type="text" id="url-pattern" placeholder="例如: /user/, profile">
                        </div>
                        
                        <div class="form-group">
                            <label for="exclude-pattern">URL排除包含</label>
                            <input type="text" id="exclude-pattern" placeholder="例如: logout, admin, login">
                        </div>
                    </div>
                    
                    <div class="demo-mode" id="demo-mode-info">
                        <i class="fas fa-info-circle"></i> <strong>演示模式已启用</strong><br>
                        在此模式下，爬虫不会进行实际网络请求，而是使用内置的示例数据进行演示。要测试实际爬取功能，请切换到"CORS代理"或"直接请求"模式（注意：直接请求需要目标网站支持CORS）。
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress" id="progress"></div>
                        </div>
                        <div class="progress-info">
                            <span id="progress-text">准备开始</span>
                            <span id="progress-percent">0%</span>
                        </div>
                    </div>
                    
                    <div class="buttons-row">
                        <button class="btn btn-success" onclick="startCrawling()" id="start-btn">
                            <i class="fas fa-play"></i> 开始爬取
                        </button>
                        <button class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-redo"></i> 重置设置
                        </button>
                    </div>
                    
                    <div class="loading" id="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text" id="loading-text">正在初始化爬虫...</div>
                        <div id="page-status"></div>
                    </div>
                </div>
                
                <!-- 高级设置标签 -->
                <div id="advanced-tab" class="tab-content">
                    <h3><i class="fas fa-tachometer-alt"></i> 性能设置</h3>
                    <div class="settings-grid">
                        <div class="form-group">
                            <label for="delay">请求延迟(ms) <span class="label-hint">(防止被封锁)</span></label>
                            <input type="number" id="delay" value="1000" min="0" max="10000">
                        </div>
                        <div class="form-group">
                            <label for="timeout">请求超时(秒)</label>
                            <input type="number" id="timeout" value="30" min="5" max="120">
                        </div>
                    </div>
                    
                    <h3><i class="fas fa-code"></i> 爬取选择器</h3>
                    <div class="form-group">
                        <label for="link-selector">链接CSS选择器 <span class="label-hint">(留空则选择所有a标签)</span></label>
                        <input type="text" id="link-selector" placeholder="例如: .user-link, a[href*='/user/']">
                    </div>
                    
                    <h3><i class="fas fa-file-export"></i> 导出设置</h3>
                    <div class="form-group">
                        <label for="export-filename">导出文件前缀</label>
                        <input type="text" id="export-filename" placeholder="user_links" value="user_links">
                    </div>
                    
                    <div class="form-group">
                        <label for="export-date-format">日期格式</label>
                        <select id="export-date-format">
                            <option value="timestamp">时间戳</option>
                            <option value="date" selected>年月日</option>
                            <option value="datetime">年月日时分秒</option>
                        </select>
                    </div>
                    
                    <div class="buttons-row">
                        <button class="btn" onclick="saveSettings()">
                            <i class="fas fa-save"></i> 保存设置
                        </button>
                        <button class="btn btn-secondary" onclick="loadDefaultSettings()">
                            <i class="fas fa-undo"></i> 恢复默认
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：结果区域 -->
            <div class="section results-section">
                <div class="results-header">
                    <h2><i class="fas fa-list"></i> 爬取结果</h2>
                    <div class="result-count" id="result-count">0 个链接</div>
                </div>
                
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value" id="stat-pages">0</div>
                        <div class="stat-label">已爬页面</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="stat-links">0</div>
                        <div class="stat-label">总链接数</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="stat-unique">0</div>
                        <div class="stat-label">去重后</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="stat-time">0s</div>
                        <div class="stat-label">耗时</div>
                    </div>
                </div>
                
                <div class="result-summary" id="result-summary" style="display: none;">
                    <strong><i class="fas fa-info-circle"></i> 结果摘要:</strong>
                    <div id="summary-text"></div>
                </div>
                
                <div class="result-filter">
                    <input type="text" id="filter-results" placeholder="筛选结果...">
                </div>
                
                <div class="results-container" id="results-container">
                    <div class="empty-state" id="empty-results">
                        <i class="fas fa-inbox"></i>
                        <h3>暂无结果</h3>
                        <p>配置爬虫设置并开始爬取以显示结果</p>
                        <div class="quick-actions" style="justify-content: center; margin-top: 20px;">
                            <button class="quick-action-btn" onclick="showExampleData()">
                                <i class="fas fa-eye"></i> 查看示例
                            </button>
                            <button class="quick-action-btn" onclick="startCrawling()">
                                <i class="fas fa-play"></i> 开始演示
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="pagination-info" id="pagination-info" style="display: none;">
                    <strong><i class="fas fa-sitemap"></i> 分页信息:</strong>
                    <span id="page-range-display"></span> | 
                    <span id="current-page-display"></span>
                </div>
                
                <div class="export-options">
                    <div class="export-format-selector">
                        <label for="export-format">导出格式:</label>
                        <select id="export-format">
                            <option value="excel">Excel (.xlsx)</option>
                            <option value="text">文本文件 (.txt)</option>
                            <option value="csv">CSV文件 (.csv)</option>
                            <option value="json">JSON文件 (.json)</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="exportData()" id="export-btn" disabled>
                        <i class="fas fa-download"></i> 导出数据
                    </button>
                    <button class="btn btn-warning" onclick="previewExport()" id="preview-btn" disabled>
                        <i class="fas fa-eye"></i> 预览导出
                    </button>
                </div>
                
                <div class="export-preview" id="export-preview" style="display: none;">
                    <!-- 导出预览将在这里显示 -->
                </div>
                
                <div class="buttons-row buttons-row-3" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="clearResults()">
                        <i class="fas fa-trash"></i> 清除结果
                    </button>
                    <button class="btn" onclick="copyResultsToClipboard()" id="copy-btn" disabled>
                        <i class="fas fa-copy"></i> 复制结果
                    </button>
                    <button class="btn" onclick="downloadResults()" id="download-btn" disabled>
                        <i class="fas fa-save"></i> 保存结果
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <div>操作成功完成！</div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // 全局变量
        let collectedLinks = [];
        let crawledPages = 0;
        let totalPagesToCrawl = 0;
        let startTime = 0;
        let isCrawling = false;
        let currentPage = 1;
        let proxyMode = 'demo';
        let filteredLinks = [];
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载保存的设置
            loadSavedSettings();
            
            // 绑定分页模式切换事件
            document.querySelectorAll('input[name="page-mode"]').forEach(radio => {
                radio.addEventListener('change', updatePageControls);
            });
            
            // 绑定代理模式切换事件
            document.getElementById('proxy-mode').addEventListener('change', updateProxyMode);
            
            // 绑定结果筛选事件
            document.getElementById('filter-results').addEventListener('input', filterResults);
            
            // 初始化页面控制显示
            updatePageControls();
            updateProxyMode();
            
            // 初始状态显示空结果
            displayEmptyResults();
        });
        
        // 切换标签页
        function switchTab(tabName) {
            // 更新标签状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 激活选中的标签
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        // 切换高级选项显示
        function toggleAdvanced() {
            const content = document.getElementById('advanced-content');
            const chevron = document.getElementById('advanced-chevron');
            
            content.classList.toggle('expanded');
            chevron.classList.toggle('fa-chevron-down');
            chevron.classList.toggle('fa-chevron-up');
        }
        
        // 更新代理模式
        function updateProxyMode() {
            proxyMode = document.getElementById('proxy-mode').value;
            const proxyStatus = document.getElementById('proxy-status');
            const demoModeInfo = document.getElementById('demo-mode-info');
            
            let statusText = '';
            let statusClass = '';
            
            switch(proxyMode) {
                case 'demo':
                    statusText = '当前：演示模式（无网络请求）';
                    statusClass = 'active';
                    demoModeInfo.style.display = 'block';
                    break;
                case 'direct':
                    statusText = '当前：直接请求（仅同源或CORS允许）';
                    statusClass = 'warning';
                    demoModeInfo.style.display = 'none';
                    break;
                case 'cors':
                    statusText = '当前：CORS代理（使用代理服务）';
                    statusClass = 'active';
                    demoModeInfo.style.display = 'none';
                    break;
            }
            
            proxyStatus.textContent = statusText;
            proxyStatus.className = `proxy-status ${statusClass}`;
        }
        
        // 更新页面控制显示
        function updatePageControls() {
            const pageMode = document.querySelector('input[name="page-mode"]:checked').value;
            
            // 隐藏所有控制
            document.getElementById('page-range-controls').style.display = 'none';
            document.getElementById('single-page-control').style.display = 'none';
            
            // 显示对应的控制
            if (pageMode === 'range') {
                document.getElementById('page-range-controls').style.display = 'block';
            } else if (pageMode === 'single') {
                document.getElementById('single-page-control').style.display = 'block';
            }
        }
        
        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const icon = notification.querySelector('i');
            
            // 设置消息和类型
            notification.querySelector('div').textContent = message;
            notification.className = `notification ${type}`;
            
            // 更新图标
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                icon.className = 'fas fa-exclamation-triangle';
            }
            
            // 显示通知
            notification.classList.add('show');
            
            // 自动隐藏
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
        
        // 更新进度
        function updateProgress(percentage, text) {
            const progressBar = document.getElementById('progress');
            const progressPercent = document.getElementById('progress-percent');
            const progressText = document.getElementById('progress-text');
            
            progressBar.style.width = percentage + '%';
            progressPercent.textContent = Math.round(percentage) + '%';
            progressText.textContent = text;
        }
        
        // 更新统计信息
        function updateStats() {
            const uniqueLinks = [...new Set(collectedLinks.map(l => l.url))];
            
            document.getElementById('stat-pages').textContent = crawledPages;
            document.getElementById('stat-links').textContent = collectedLinks.length;
            document.getElementById('stat-unique').textContent = uniqueLinks.length;
            
            if (startTime > 0) {
                const elapsed = (Date.now() - startTime) / 1000;
                document.getElementById('stat-time').textContent = elapsed.toFixed(1) + 's';
            }
        }
        
        // 更新结果摘要
        function updateSummary() {
            const summaryElement = document.getElementById('result-summary');
            const summaryText = document.getElementById('summary-text');
            const uniqueLinks = [...new Set(collectedLinks.map(l => l.url))];
            
            if (collectedLinks.length === 0) {
                summaryElement.style.display = 'none';
                return;
            }
            
            // 统计页面分布
            const pageDistribution = {};
            collectedLinks.forEach(link => {
                pageDistribution[link.page] = (pageDistribution[link.page] || 0) + 1;
            });
            
            const pageDistStr = Object.entries(pageDistribution)
                .map(([page, count]) => `第${page}页: ${count}个`)
                .join(', ');
            
            summaryText.innerHTML = `
                <div>共找到 <strong>${collectedLinks.length}</strong> 个链接，去重后为 <strong>${uniqueLinks.length}</strong> 个</div>
                <div>页面分布: ${pageDistStr}</div>
                <div>爬取时间: ${new Date().toLocaleString()}</div>
            `;
            
            summaryElement.style.display = 'block';
        }
        
        // 显示空结果状态
        function displayEmptyResults() {
            const container = document.getElementById('results-container');
            const emptyState = document.getElementById('empty-results');
            
            container.innerHTML = '';
            container.appendChild(emptyState);
            emptyState.style.display = 'block';
            
            document.getElementById('result-count').textContent = '0 个链接';
            document.getElementById('result-summary').style.display = 'none';
            document.getElementById('pagination-info').style.display = 'none';
            
            // 禁用导出相关按钮
            document.getElementById('export-btn').disabled = true;
            document.getElementById('preview-btn').disabled = true;
            document.getElementById('copy-btn').disabled = true;
            document.getElementById('download-btn').disabled = true;
            
            // 清空统计数据
            document.getElementById('stat-pages').textContent = '0';
            document.getElementById('stat-links').textContent = '0';
            document.getElementById('stat-unique').textContent = '0';
            document.getElementById('stat-time').textContent = '0s';
        }
        
        // 重置表单
        function resetForm() {
            document.getElementById('base-url').value = '';
            document.getElementById('start-page').value = '1';
            document.getElementById('end-page').value = '5';
            document.getElementById('single-page').value = '1';
            document.getElementById('max-results').value = '50';
            document.getElementById('custom-filter').value = '';
            document.getElementById('url-pattern').value = '';
            document.getElementById('exclude-pattern').value = '';
            document.getElementById('delay').value = '1000';
            document.getElementById('timeout').value = '30';
            document.getElementById('link-selector').value = '';
            document.getElementById('export-filename').value = 'user_links';
            document.getElementById('export-date-format').value = 'date';
            document.getElementById('export-format').value = 'excel';
            document.getElementById('proxy-mode').value = 'demo';
            
            // 重置复选框
            document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // 重新选中默认选项
            document.getElementById('filter-user').checked = true;
            document.getElementById('filter-profile').checked = true;
            document.getElementById('page-all').checked = true;
            
            updatePageControls();
            updateProxyMode();
            updateProgress(0, '准备开始');
            
            // 清空结果
            collectedLinks = [];
            crawledPages = 0;
            displayEmptyResults();
            
            showNotification('表单已重置为默认值');
        }
        
        // 清除结果
        function clearResults() {
            if (isCrawling) {
                showNotification('请先停止正在进行的爬取任务', 'warning');
                return;
            }
            
            collectedLinks = [];
            crawledPages = 0;
            displayEmptyResults();
            showNotification('结果已清除');
        }
        
        // 保存设置
        function saveSettings() {
            const settings = {
                baseUrl: document.getElementById('base-url').value,
                pageMode: document.querySelector('input[name="page-mode"]:checked').value,
                startPage: document.getElementById('start-page').value,
                endPage: document.getElementById('end-page').value,
                singlePage: document.getElementById('single-page').value,
                maxResults: document.getElementById('max-results').value,
                customFilter: document.getElementById('custom-filter').value,
                urlPattern: document.getElementById('url-pattern').value,
                excludePattern: document.getElementById('exclude-pattern').value,
                delay: document.getElementById('delay').value,
                timeout: document.getElementById('timeout').value,
                linkSelector: document.getElementById('link-selector').value,
                exportFilename: document.getElementById('export-filename').value,
                exportDateFormat: document.getElementById('export-date-format').value,
                exportFormat: document.getElementById('export-format').value,
                proxyMode: document.getElementById('proxy-mode').value,
                
                // 复选框状态
                filters: {
                    user: document.getElementById('filter-user').checked,
                    profile: document.getElementById('filter-profile').checked,
                    member: document.getElementById('filter-member').checked,
                    account: document.getElementById('filter-account').checked,
                    author: document.getElementById('filter-author').checked,
                    people: document.getElementById('filter-people').checked
                }
            };
            
            localStorage.setItem('crawlerSettings', JSON.stringify(settings));
            showNotification('设置已保存到本地存储');
        }
        
        // 加载保存的设置
        function loadSavedSettings() {
            const saved = localStorage.getItem('crawlerSettings');
            if (!saved) return;
            
            try {
                const settings = JSON.parse(saved);
                
                // 应用设置
                document.getElementById('base-url').value = settings.baseUrl || '';
                document.getElementById('start-page').value = settings.startPage || '1';
                document.getElementById('end-page').value = settings.endPage || '5';
                document.getElementById('single-page').value = settings.singlePage || '1';
                document.getElementById('max-results').value = settings.maxResults || '50';
                document.getElementById('custom-filter').value = settings.customFilter || '';
                document.getElementById('url-pattern').value = settings.urlPattern || '';
                document.getElementById('exclude-pattern').value = settings.excludePattern || '';
                document.getElementById('delay').value = settings.delay || '1000';
                document.getElementById('timeout').value = settings.timeout || '30';
                document.getElementById('link-selector').value = settings.linkSelector || '';
                document.getElementById('export-filename').value = settings.exportFilename || 'user_links';
                document.getElementById('export-date-format').value = settings.exportDateFormat || 'date';
                document.getElementById('export-format').value = settings.exportFormat || 'excel';
                document.getElementById('proxy-mode').value = settings.proxyMode || 'demo';
                
                // 设置分页模式
                const pageMode = settings.pageMode || 'all';
                document.getElementById(`page-${pageMode}`).checked = true;
                
                // 设置复选框
                if (settings.filters) {
                    document.getElementById('filter-user').checked = settings.filters.user || false;
                    document.getElementById('filter-profile').checked = settings.filters.profile || false;
                    document.getElementById('filter-member').checked = settings.filters.member || false;
                    document.getElementById('filter-account').checked = settings.filters.account || false;
                    document.getElementById('filter-author').checked = settings.filters.author || false;
                    document.getElementById('filter-people').checked = settings.filters.people || false;
                }
                
                updatePageControls();
                updateProxyMode();
                
            } catch (e) {
                console.error('加载设置失败:', e);
            }
        }
        
        // 加载默认设置
        function loadDefaultSettings() {
            localStorage.removeItem('crawlerSettings');
            resetForm();
            showNotification('已恢复默认设置');
        }
        
        // 开始爬取
        async function startCrawling() {
            if (isCrawling) {
                showNotification('爬取正在进行中，请等待完成', 'warning');
                return;
            }
            
            // 收集筛选条件
            const filters = [];
            if (document.getElementById('filter-user').checked) filters.push('user');
            if (document.getElementById('filter-profile').checked) filters.push('profile');
            if (document.getElementById('filter-member').checked) filters.push('member');
            if (document.getElementById('filter-account').checked) filters.push('account');
            if (document.getElementById('filter-author').checked) filters.push('author');
            if (document.getElementById('filter-people').checked) filters.push('people');
            
            const customFilter = document.getElementById('custom-filter').value;
            if (customFilter) {
                customFilter.split(',').forEach(item => {
                    const trimmed = item.trim();
                    if (trimmed) filters.push(trimmed.toLowerCase());
                });
            }
            
            if (filters.length === 0) {
                showNotification('请至少选择一个筛选条件', 'error');
                return;
            }
            
            // 确定要爬取的页面范围
            const pageMode = document.querySelector('input[name="page-mode"]:checked').value;
            let startPage = 1;
            let endPage = 1;
            
            if (pageMode === 'range') {
                startPage = parseInt(document.getElementById('start-page').value);
                endPage = parseInt(document.getElementById('end-page').value);
                if (startPage > endPage) {
                    showNotification('起始页码不能大于结束页码', 'error');
                    return;
                }
                totalPagesToCrawl = endPage - startPage + 1;
            } else if (pageMode === 'single') {
                startPage = parseInt(document.getElementById('single-page').value);
                endPage = startPage;
                totalPagesToCrawl = 1;
            } else {
                // 'all' 模式 - 我们将爬取直到找不到更多页面或达到限制
                startPage = 1;
                endPage = 5; // 默认限制5页，防止无限爬取
                totalPagesToCrawl = 5;
            }
            
            // 其他设置
            const maxResults = parseInt(document.getElementById('max-results').value);
            const urlPattern = document.getElementById('url-pattern').value;
            const excludePattern = document.getElementById('exclude-pattern').value;
            const delay = parseInt(document.getElementById('delay').value);
            const linkSelector = document.getElementById('link-selector').value;
            
            // 显示加载状态
            document.getElementById('loading').style.display = 'block';
            document.getElementById('start-btn').disabled = true;
            document.getElementById('export-btn').disabled = true;
            document.getElementById('preview-btn').disabled = true;
            document.getElementById('copy-btn').disabled = true;
            document.getElementById('download-btn').disabled = true;
            isCrawling = true;
            
            // 清空旧结果
            collectedLinks = [];
            crawledPages = 0;
            startTime = Date.now();
            updateStats();
            
            // 根据代理模式执行爬取
            try {
                if (proxyMode === 'demo') {
                    // 演示模式：使用模拟数据
                    await simulateCrawling(startPage, endPage, maxResults, filters, urlPattern, excludePattern);
                } else {
                    // 实际爬取模式
                    const baseUrl = document.getElementById('base-url').value;
                    if (!baseUrl) {
                        throw new Error('请输入基础URL');
                    }
                    
                    await realCrawling(baseUrl, startPage, endPage, {
                        filters,
                        maxResults,
                        urlPattern,
                        excludePattern,
                        linkSelector,
                        delay
                    });
                }
                
                updateProgress(100, '爬取完成！');
                
                // 显示成功通知
                const uniqueLinks = [...new Set(collectedLinks.map(l => l.url))];
                showNotification(`成功爬取 ${crawledPages} 页，找到 ${collectedLinks.length} 个链接（去重后: ${uniqueLinks.length}）`);
                
            } catch (error) {
                console.error('爬取失败:', error);
                showNotification(`爬取失败: ${error.message}`, 'error');
                
                // 显示已有的结果
                if (collectedLinks.length > 0) {
                    showNotification(`已保存部分结果 (${collectedLinks.length} 个链接)`, 'warning');
                }
            } finally {
                // 恢复UI状态
                document.getElementById('loading').style.display = 'none';
                document.getElementById('start-btn').disabled = false;
                
                // 显示结果
                if (collectedLinks.length > 0) {
                    displayResults(collectedLinks);
                    updateSummary();
                    
                    // 启用导出相关按钮
                    document.getElementById('export-btn').disabled = false;
                    document.getElementById('preview-btn').disabled = false;
                    document.getElementById('copy-btn').disabled = false;
                    document.getElementById('download-btn').disabled = false;
                } else {
                    displayEmptyResults();
                }
                
                isCrawling = false;
                
                // 延迟重置进度条
                setTimeout(() => updateProgress(0, '准备开始'), 2000);
            }
        }
        
        // 模拟爬取（演示模式）
        async function simulateCrawling(startPage, endPage, maxResults, filters, urlPattern, excludePattern) {
            for (let page = startPage; page <= endPage && isCrawling; page++) {
                currentPage = page;
                
                // 更新进度和状态
                const progressPercent = ((page - startPage) / (endPage - startPage + 1)) * 100;
                updateProgress(progressPercent, `演示模式：正在模拟爬取第 ${page} 页...`);
                document.getElementById('page-status').innerHTML = 
                    `<div style="margin-top: 10px; font-size: 0.9em;">演示模式 - 生成示例数据</div>`;
                
                // 生成模拟数据
                await generateDemoData(page, filters, maxResults, urlPattern, excludePattern);
                
                crawledPages++;
                updateStats();
                
                // 显示分页信息
                document.getElementById('pagination-info').style.display = 'block';
                document.getElementById('page-range-display').textContent = `页面: ${startPage}~${endPage}`;
                document.getElementById('current-page-display').textContent = `当前: ${page}/${endPage}`;
                
                // 模拟延迟
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }
        
        // 实际爬取
        async function realCrawling(baseUrl, startPage, endPage, options) {
            for (let page = startPage; page <= endPage && isCrawling; page++) {
                currentPage = page;
                const url = baseUrl.replace('{page}', page);
                
                // 更新进度和状态
                const progressPercent = ((page - startPage) / (endPage - startPage + 1)) * 100;
                updateProgress(progressPercent, `正在爬取第 ${page} 页...`);
                document.getElementById('page-status').innerHTML = 
                    `<div style="margin-top: 10px; font-size: 0.9em;">当前页面: ${url}</div>`;
                
                // 根据代理模式爬取页面
                if (proxyMode === 'direct') {
                    // 直接请求（需要目标网站支持CORS）
                    await crawlPageDirect(url, options, page);
                } else if (proxyMode === 'cors') {
                    // 使用CORS代理
                    await crawlPageWithProxy(url, options, page);
                }
                
                crawledPages++;
                updateStats();
                
                // 显示分页信息
                document.getElementById('pagination-info').style.display = 'block';
                document.getElementById('page-range-display').textContent = `页面: ${startPage}~${endPage}`;
                document.getElementById('current-page-display').textContent = `当前: ${page}/${endPage}`;
                
                // 延迟（避免请求过快）
                if (page < endPage && options.delay > 0) {
                    await new Promise(resolve => setTimeout(resolve, options.delay));
                }
            }
        }
        
        // 直接爬取页面（需要CORS支持）
        async function crawlPageDirect(url, options, pageNum) {
            // 在实际应用中实现
            showNotification('直接请求模式需要目标网站支持CORS，切换到演示模式', 'warning');
            await generateDemoData(pageNum, options.filters, options.maxResults, options.urlPattern, options.excludePattern);
        }
        
        // 使用代理爬取页面
        async function crawlPageWithProxy(url, options, pageNum) {
            // 在实际应用中实现
            showNotification('CORS代理模式在实际部署中需要配置服务器代理，切换到演示模式', 'warning');
            await generateDemoData(pageNum, options.filters, options.maxResults, options.urlPattern, options.excludePattern);
        }
        
        // 生成演示数据（与筛选条件一致）
        async function generateDemoData(pageNum, filters, maxResults, urlPattern, excludePattern) {
            // 生成与筛选条件匹配的演示数据
            const demoLinks = [];
            const domains = [
                'https://github.com',
                'https://stackoverflow.com',
                'https://linkedin.com',
                'https://twitter.com',
                'https://example.com'
            ];
            
            // 使用传入的筛选条件，如果没有则使用默认
            const filterKeywords = filters && filters.length > 0 ? filters : ['user', 'profile'];
            
            for (let i = 1; i <= 15 && demoLinks.length < maxResults; i++) {
                const domain = domains[Math.floor(Math.random() * domains.length)];
                const keyword = filterKeywords[Math.floor(Math.random() * filterKeywords.length)];
                const username = `user${pageNum}_${i}`;
                const urlPath = `/${keyword}/${username}`;
                const url = `${domain}${urlPath}`;
                
                // 检查URL模式筛选
                if (urlPattern) {
                    const patterns = urlPattern.split(',').map(p => p.trim());
                    const matchesPattern = patterns.some(pattern => 
                        url.toLowerCase().includes(pattern.toLowerCase())
                    );
                    if (!matchesPattern) continue;
                }
                
                // 检查排除模式
                if (excludePattern) {
                    const excludePatterns = excludePattern.split(',').map(p => p.trim());
                    const shouldExclude = excludePatterns.some(pattern => 
                        url.toLowerCase().includes(pattern.toLowerCase())
                    );
                    if (shouldExclude) continue;
                }
                
                demoLinks.push({
                    url: url,
                    text: `${username} - ${keyword.charAt(0).toUpperCase() + keyword.slice(1)} (页面 ${pageNum})`,
                    page: pageNum,
                    source: `https://example.com/${keyword}s?page=${pageNum}`,
                    timestamp: new Date().toLocaleString()
                });
            }
            
            // 添加到总结果
            collectedLinks.push(...demoLinks);
            
            // 限制总结果数量
            if (collectedLinks.length > maxResults * 3) { // 允许最多3页的数据
                collectedLinks = collectedLinks.slice(0, maxResults * 3);
            }
        }
        
        // 显示示例数据
        function showExampleData() {
            // 使用当前筛选条件生成示例数据
            const filters = getCurrentFilters();
            
            collectedLinks = [];
            for (let page = 1; page <= 3; page++) {
                for (let i = 1; i <= 10; i++) {
                    const keyword = filters[Math.floor(Math.random() * filters.length)] || 'user';
                    const domains = ['https://github.com', 'https://linkedin.com', 'https://example.com'];
                    const domain = domains[Math.floor(Math.random() * domains.length)];
                    
                    collectedLinks.push({
                        url: `${domain}/${keyword}/example_user_${page}_${i}`,
                        text: `示例用户 ${page}_${i} (${keyword})`,
                        page: page,
                        source: `https://example.com/${keyword}s?page=${page}`,
                        timestamp: new Date().toLocaleString()
                    });
                }
            }
            
            crawledPages = 3;
            updateStats();
            displayResults(collectedLinks);
            updateSummary();
            
            // 显示分页信息
            document.getElementById('pagination-info').style.display = 'block';
            document.getElementById('page-range-display').textContent = `页面: 1~3`;
            document.getElementById('current-page-display').textContent = `当前: 3/3`;
            
            // 启用导出相关按钮
            document.getElementById('export-btn').disabled = false;
            document.getElementById('preview-btn').disabled = false;
            document.getElementById('copy-btn').disabled = false;
            document.getElementById('download-btn').disabled = false;
            
            showNotification('已加载示例数据');
        }
        
        // 获取当前筛选条件
        function getCurrentFilters() {
            const filters = [];
            if (document.getElementById('filter-user').checked) filters.push('user');
            if (document.getElementById('filter-profile').checked) filters.push('profile');
            if (document.getElementById('filter-member').checked) filters.push('member');
            if (document.getElementById('filter-account').checked) filters.push('account');
            if (document.getElementById('filter-author').checked) filters.push('author');
            if (document.getElementById('filter-people').checked) filters.push('people');
            
            const customFilter = document.getElementById('custom-filter').value;
            if (customFilter) {
                customFilter.split(',').forEach(item => {
                    const trimmed = item.trim();
                    if (trimmed) filters.push(trimmed.toLowerCase());
                });
            }
            
            return filters.length > 0 ? filters : ['user', 'profile'];
        }
        
        // 显示结果
        function displayResults(links) {
            const container = document.getElementById('results-container');
            const resultCount = document.getElementById('result-count');
            
            // 保存完整结果用于筛选
            filteredLinks = links;
            
            // 应用当前筛选
            filterResults();
            
            // 更新计数
            resultCount.textContent = `${links.length} 个链接`;
        }
        
        // 筛选结果
        function filterResults() {
            const filterText = document.getElementById('filter-results').value.toLowerCase();
            const container = document.getElementById('results-container');
            
            if (collectedLinks.length === 0) {
                displayEmptyResults();
                return;
            }
            
            // 筛选链接
            const filtered = filterText ? 
                collectedLinks.filter(link => 
                    link.url.toLowerCase().includes(filterText) || 
                    link.text.toLowerCase().includes(filterText) ||
                    link.source.toLowerCase().includes(filterText)
                ) : 
                collectedLinks;
            
            // 显示筛选结果数量
            const resultCount = document.getElementById('result-count');
            resultCount.textContent = `${filtered.length} 个链接${filterText ? ` (筛选后)` : ''}`;
            
            // 生成结果HTML
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>未找到匹配的结果</h3>
                        <p>尝试调整筛选条件</p>
                    </div>
                `;
                return;
            }
            
            // 限制显示数量，避免页面卡顿
            const displayLimit = 100;
            const linksToDisplay = filtered.slice(0, displayLimit);
            
            // 生成结果HTML
            container.innerHTML = linksToDisplay.map((link, index) => `
                <div class="result-item">
                    <div class="result-info">
                        <div class="result-url">${link.url}</div>
                        <div>${link.text}</div>
                        <div class="result-details">
                            <span><i class="fas fa-file-alt"></i> 页面: ${link.page}</span>
                            <span><i class="fas fa-clock"></i> ${link.timestamp}</span>
                        </div>
                    </div>
                    <div class="result-actions">
                        <a href="${link.url}" target="_blank" class="action-btn" title="打开链接" onclick="event.stopPropagation();">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                        <button class="action-btn" onclick="copyToClipboard('${link.url.replace(/'/g, "\\'")}')" title="复制链接">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // 如果有限制显示，添加提示
            if (filtered.length > displayLimit) {
                container.innerHTML += `
                    <div class="result-item" style="text-align: center; color: var(--gray);">
                        <i class="fas fa-info-circle"></i>
                        已显示前 ${displayLimit} 个结果，共有 ${filtered.length} 个匹配链接
                    </div>
                `;
            }
        }
        
        // 复制到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('链接已复制到剪贴板');
            }).catch(err => {
                // 备用方法
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('链接已复制到剪贴板');
            });
        }
        
        // 复制所有结果到剪贴板
        function copyResultsToClipboard() {
            if (collectedLinks.length === 0) {
                showNotification('没有数据可复制', 'warning');
                return;
            }
            
            const format = document.getElementById('export-format').value;
            let text = '';
            
            // 根据格式生成文本
            if (format === 'text') {
                text = formatAsText(collectedLinks);
            } else if (format === 'csv') {
                text = formatAsCSV(collectedLinks);
            } else if (format === 'json') {
                text = formatAsJSON(collectedLinks);
            } else {
                text = formatAsText(collectedLinks); // 默认使用文本格式
            }
            
            navigator.clipboard.writeText(text).then(() => {
                showNotification(`已复制 ${collectedLinks.length} 个结果到剪贴板`);
            }).catch(err => {
                showNotification('复制失败，请重试', 'error');
            });
        }
        
        // 下载结果
        function downloadResults() {
            if (collectedLinks.length === 0) {
                showNotification('没有数据可下载', 'warning');
                return;
            }
            
            // 临时导出数据
            exportData();
        }
        
        // 导出数据
        function exportData() {
            if (collectedLinks.length === 0) {
                showNotification('没有数据可导出', 'error');
                return;
            }
            
            const format = document.getElementById('export-format').value;
            const filenamePrefix = document.getElementById('export-filename').value || 'user_links';
            const dateFormat = document.getElementById('export-date-format').value;
            
            // 生成文件名
            let dateSuffix = '';
            if (dateFormat === 'timestamp') {
                dateSuffix = '_' + new Date().getTime();
            } else if (dateFormat === 'date') {
                const now = new Date();
                dateSuffix = '_' + now.getFullYear() + '-' + 
                           (now.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                           now.getDate().toString().padStart(2, '0');
            } else if (dateFormat === 'datetime') {
                const now = new Date();
                dateSuffix = '_' + now.getFullYear() + '-' + 
                           (now.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                           now.getDate().toString().padStart(2, '0') + '_' +
                           now.getHours().toString().padStart(2, '0') + '-' + 
                           now.getMinutes().toString().padStart(2, '0') + '-' + 
                           now.getSeconds().toString().padStart(2, '0');
            }
            
            // 根据格式导出
            if (format === 'excel') {
                exportToExcel(filenamePrefix + dateSuffix + '.xlsx');
            } else if (format === 'text') {
                exportToText(filenamePrefix + dateSuffix + '.txt');
            } else if (format === 'csv') {
                exportToCSV(filenamePrefix + dateSuffix + '.csv');
            } else if (format === 'json') {
                exportToJSON(filenamePrefix + dateSuffix + '.json');
            }
        }
        
        // 预览导出
        function previewExport() {
            if (collectedLinks.length === 0) {
                showNotification('没有数据可预览', 'warning');
                return;
            }
            
            const format = document.getElementById('export-format').value;
            const previewElement = document.getElementById('export-preview');
            
            let previewContent = '';
            let title = '';
            
            // 根据格式生成预览
            if (format === 'text') {
                previewContent = formatAsText(collectedLinks.slice(0, 10)); // 只预览前10条
                title = '文本格式预览 (前10条):';
            } else if (format === 'csv') {
                previewContent = formatAsCSV(collectedLinks.slice(0, 10));
                title = 'CSV格式预览 (前10条):';
            } else if (format === 'json') {
                previewContent = formatAsJSON(collectedLinks.slice(0, 10));
                title = 'JSON格式预览 (前10条):';
            } else {
                previewContent = 'Excel格式不支持预览，请直接导出查看';
                title = 'Excel格式:';
            }
            
            previewElement.innerHTML = `<strong>${title}</strong><br><br>${previewContent}`;
            previewElement.style.display = 'block';
            
            // 自动滚动到预览
            previewElement.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 格式化为文本
        function formatAsText(links) {
            let text = `用户链接爬取结果\n`;
            text += `生成时间: ${new Date().toLocaleString()}\n`;
            text += `总计: ${links.length} 个链接\n`;
            text += `========================================\n\n`;
            
            links.forEach((link, index) => {
                text += `${index + 1}. ${link.url}\n`;
                text += `   标题: ${link.text}\n`;
                text += `   页面: ${link.page} | 时间: ${link.timestamp}\n`;
                text += `   来源: ${link.source}\n\n`;
            });
            
            return text;
        }
        
        // 格式化为CSV
        function formatAsCSV(links) {
            let csv = '序号,用户链接,链接文本,来源页面,采集时间,来源URL\n';
            
            links.forEach((link, index) => {
                csv += `${index + 1},"${link.url.replace(/"/g, '""')}","${link.text.replace(/"/g, '""')}",${link.page},"${link.timestamp}","${link.source.replace(/"/g, '""')}"\n`;
            });
            
            return csv;
        }
        
        // 格式化为JSON
        function formatAsJSON(links) {
            const data = {
                metadata: {
                    generated: new Date().toISOString(),
                    total: links.length,
                    crawledPages: crawledPages
                },
                links: links.map((link, index) => ({
                    id: index + 1,
                    url: link.url,
                    text: link.text,
                    page: link.page,
                    timestamp: link.timestamp,
                    source: link.source
                }))
            };
            
            return JSON.stringify(data, null, 2);
        }
        
        // 导出为Excel
        function exportToExcel(filename) {
            try {
                // 准备数据（去重）
                const uniqueLinksMap = new Map();
                collectedLinks.forEach(link => {
                    if (!uniqueLinksMap.has(link.url)) {
                        uniqueLinksMap.set(link.url, link);
                    }
                });
                
                const uniqueLinks = Array.from(uniqueLinksMap.values());
                
                const data = uniqueLinks.map((link, index) => ({
                    '序号': index + 1,
                    '用户链接': link.url,
                    '链接文本': link.text,
                    '来源页面': link.page,
                    '采集时间': link.timestamp,
                    '来源URL': link.source
                }));
                
                // 创建工作簿
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(data);
                
                // 设置列宽
                const wscols = [
                    { wch: 8 },   // 序号
                    { wch: 50 },  // 用户链接
                    { wch: 30 },  // 链接文本
                    { wch: 10 },  // 来源页面
                    { wch: 20 },  // 采集时间
                    { wch: 40 }   // 来源URL
                ];
                ws['!cols'] = wscols;
                
                // 获取工作表名称
                const sheetName = '用户链接';
                XLSX.utils.book_append_sheet(wb, ws, sheetName.substring(0, 31)); // Excel工作表名最多31字符
                
                // 导出文件
                XLSX.writeFile(wb, filename);
                
                showNotification(`成功导出 ${uniqueLinks.length} 条数据到 ${filename}`);
                
            } catch (error) {
                console.error('导出失败:', error);
                showNotification('导出失败: ' + error.message, 'error');
            }
        }
        
        // 导出为文本
        function exportToText(filename) {
            try {
                const text = formatAsText(collectedLinks);
                const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`成功导出 ${collectedLinks.length} 条数据到 ${filename}`);
            } catch (error) {
                console.error('导出失败:', error);
                showNotification('导出失败: ' + error.message, 'error');
            }
        }
        
        // 导出为CSV
        function exportToCSV(filename) {
            try {
                const csv = formatAsCSV(collectedLinks);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`成功导出 ${collectedLinks.length} 条数据到 ${filename}`);
            } catch (error) {
                console.error('导出失败:', error);
                showNotification('导出失败: ' + error.message, 'error');
            }
        }
        
        // 导出为JSON
        function exportToJSON(filename) {
            try {
                const json = formatAsJSON(collectedLinks);
                const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`成功导出 ${collectedLinks.length} 条数据到 ${filename}`);
            } catch (error) {
                console.error('导出失败:', error);
                showNotification('导出失败: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
